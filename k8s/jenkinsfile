pipeline {
    agent any

    environment {
        // Harbor (Docker Registry)
        HARBOR_URL = "harbor.local.lab"
        HARBOR_PROJECT = "library"
        HARBOR_CREDENTIALS = "harbor-creds"

        // Nexus (Maven Repository)
        NEXUS_URL = "http://nexus.local.lab:8081/repository/maven-releases/"
        NEXUS_CREDENTIALS = "nexus-cred"

        // SonarQube (Code Analysis)
        SONARQUBE_SERVER = "SonarQube"
        SONARQUBE_URL = "http://sonarqube:9000"
        SONARQUBE_CREDENTIALS = "sonar-token"

        // Kubernetes
        KUBECONFIG_CREDENTIALS = "k8s-kubeconfig"

        // Email
        EMAIL_RECIPIENTS = "almastvx@gmail.com"
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üì• Checking out source code..."
                checkout scm
            }
        }

        stage('Set Build Version') {
            steps {
                script {
                    sh "mvn versions:set -DnewVersion=0.0.${env.BUILD_NUMBER}"
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build("${HARBOR_URL}/${HARBOR_PROJECT}/myapp:${env.BUILD_NUMBER}")
                }
            }
        }

        stage('Push Docker Image to Harbor') {
            steps {
                script {
                    docker.withRegistry("http://${HARBOR_URL}", HARBOR_CREDENTIALS) {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }

        stage('Publish Artifacts to Nexus') {
            steps {
                echo "üì¶ Publishing Maven artifacts to Nexus..."
                configFileProvider([configFile(fileId: 'maven-settings', variable: 'MAVEN_SETTINGS')]) {
                    withCredentials([usernamePassword(credentialsId: NEXUS_CREDENTIALS, usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PSW')]) {
                        sh """
                            mvn clean deploy -s $MAVEN_SETTINGS \
                                -DaltDeploymentRepository=nexus::default::${NEXUS_URL} \
                                -Dnexus.username=${NEXUS_USER} \
                                -Dnexus.password=${NEXUS_PSW}
                        """
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE_SERVER}") {
                    sh "mvn sonar:sonar -Dsonar.host.url=${SONARQUBE_URL}"
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º namespace –ø–æ –≤–µ—Ç–∫–µ
                    def namespace = ""
                    if (env.BRANCH_NAME == 'main') {
                        namespace = "prod"
                    } else if (env.BRANCH_NAME == 'develop') {
                        namespace = "dev"
                    } else {
                        namespace = "stage"
                    }

                    echo "üöÄ Deploying to namespace: ${namespace}"

                    def deploymentFile = "k8s/deployment-${namespace}.yaml"

                    withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG_FILE')]) {
                        withEnv(["KUBECONFIG=${KUBECONFIG_FILE}"]) {
                            sh """
                                kubectl apply -f ${deploymentFile} -n ${namespace} --validate=false
                            """
                        }
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    def namespace = (env.BRANCH_NAME == 'main') ? "prod" : (env.BRANCH_NAME == 'develop' ? "dev" : "stage")

                    withCredentials([file(credentialsId: KUBECONFIG_CREDENTIALS, variable: 'KUBECONFIG_FILE')]) {
                        withEnv(["KUBECONFIG=${KUBECONFIG_FILE}"]) {
                            sh """
                                kubectl rollout status deployment/boardgame-deployment -n ${namespace}
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            mail to: "${EMAIL_RECIPIENTS}",
                subject: "‚úÖ SUCCESS: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                body: "‚úÖ The Jenkins job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' completed successfully.\nBuild URL: ${env.BUILD_URL}"
        }
        failure {
            mail to: "${EMAIL_RECIPIENTS}",
                subject: "‚ùå FAILURE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                body: "‚ùå The Jenkins job '${env.JOB_NAME} [${env.BUILD_NUMBER}]' failed.\nBuild URL: ${env.BUILD_URL}"
        }
        always {
            cleanWs()
        }
    }
}
